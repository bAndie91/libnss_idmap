# Testing framework for libnss_idmap

This directory contains files which are there to test `libnss_idmap`.
Start tests by `do_test.sh`. By the nature of the testing subject: it
works at system level, so for testing we need to use modified system libraries
in order to able to run test cases isolated from the rest of the system.

If copies libc.so and replaces `/etc/nsswitch.conf` in it binary-wise to
out locally modified `nsswitch.conf`, and then does the same for `libnss_idmap.so`
replacing `/etc/nss.d/idmap` to a relative path which is specific to each test cases.
These patched libraries are prepended to `LD_LIBRARY_PATH` during the test runs.

In test case folders (`test-*/`) there are `source`, `idmap.tmpl`, and `expect.tmpl`
files. The framework generated idmap config file from `idmap.tmpl` by passing its
contents through bash `eval` - so you can put shell variables in it. Beware, `eval`
runs other expressions too. I write only `$variable` expressions here which are
evaluated run-time. File `expect` is generated by the same manner. More on that later.

File `source` is included before the test case run, you can set `$getent_args` array
here. During the test run `getent "${getent_args[@]}"` is executed and the output saved
to `output` file.

File `expect` contains PCRE patterns line-by-line which are matched against the `output`.
You can add in patterns starting with `!` exclamation mark to make that pattern unexpected.
Test passes if all positive pattern match and no negative pattern does match.
